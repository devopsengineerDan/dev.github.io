<!doctype html>
<html lang="en-us">
  <head>
    <title>Best Practices for PySpark ETL Projects // Engineer Dancun</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.68.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Dancun Manyinsa" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://devopsengineerdan.github.io/css/main.min.d5ed8558bcfb3aab1e3d1790fb902decbac1f989a0d27aa3b2a2320773186707.css" />
    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Best Practices for PySpark ETL Projects"/>
<meta name="twitter:description" content="I have often lent heavily on Apache Spark and the SparkSQL APIs for operationalising any type of batch data-processing &lsquo;job&rsquo;, within a production environment where handling fluctuating volumes of data reliably and consistently are on-going business concerns. These batch data-processing jobs may involve nothing more than joining data sources and performing aggregations, or they may apply machine learning models to generate inventory recommendations - regardless of the complexity, this often reduces to defining Extract, Transform and Load (ETL) jobs."/>

    <meta property="og:title" content="Best Practices for PySpark ETL Projects" />
<meta property="og:description" content="I have often lent heavily on Apache Spark and the SparkSQL APIs for operationalising any type of batch data-processing &lsquo;job&rsquo;, within a production environment where handling fluctuating volumes of data reliably and consistently are on-going business concerns. These batch data-processing jobs may involve nothing more than joining data sources and performing aggregations, or they may apply machine learning models to generate inventory recommendations - regardless of the complexity, this often reduces to defining Extract, Transform and Load (ETL) jobs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devopsengineerdan.github.io/posts/best-practices-for-pyspark-etl/" />
<meta property="article:published_time" content="2023-09-09T13:27:53+03:00" />
<meta property="article:modified_time" content="2023-09-09T13:27:53+03:00" />


       	  <!-- Favicons 
    <link href="https://devopsengineerdan.github.io/assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts 
    <link href="https://devopsengineerdan.github.io/assets/vendor/google/css/icons.css" rel="stylesheet" />

<!-- Vendor CSS Files   -->
   <link href="https://devopsengineerdan.github.io/assets/vendor/aos/aos.css" rel="stylesheet" /> 
 <!--    <link href="https://devopsengineerdan.github.io/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" /> -->
  <!--  <link
      href="https://devopsengineerdan.github.io/assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="https://devopsengineerdan.github.io/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" /> 


    <!-- Template Main CSS File  
    <link href="https://devopsengineerdan.github.io/assets/assets/css/style.css" rel="stylesheet" />   -->
    

  </head>
  <body>
    <header class="app-header">
      <a href="https://devopsengineerdan.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Dancun Manyinsa" /></a>
      <h1>Engineer Dancun</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="https://devopsengineerdan.github.io/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="https://devopsengineerdan.github.io/tags/">Tags</a>
             - 
          
          <a class="app-header-menu-item" href="https://devopsengineerdan.github.io/about/">About</a>
      </nav>
      <p>Software Engineer, Researcher(AI and Quantum Science), and Habitual Quant</p>
      <div class="app-header-social">
        
          <a href="https://www.github.com/DancunManyinsa" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://www.linkedin.com/in/dancun-manyinsa-42518a17b/" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>Linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="mailto:dancunmoruri@gmail.com" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Best Practices for PySpark ETL Projects</h1>
      <div class="post-meta">Credit: <a href = "https://spark.apache.org/">Apache PySpark Project </a> </div>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Sep 9, 2023
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          14 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://devopsengineerdan.github.io/tags/python/">python</a>
        </div>
      </div>
    </header>
    <div class="post-content"  id="main">
      <hr>



       <!-- ======= Portfolio Section ======= -->
      <section id="portfolio" class="portfolio">
        <div class="container" data-aos="fade-up">
          <div
            class="row portfolio-container"
            data-aos="fade-up"
            data-aos-delay="200"
          >
            <div class="col-lg-4 col-md-6 portfolio-item filter-app">
              <div class="portfolio-wrap">
                <img src="https://github.com/devopsengineerDan/engineer-dancun-personal-blog/assets/48592378/5aecd34b-e722-4390-ad77-5ed10aa5f3a7" alt="etl"
                  class="img-fluid"
                  alt=""
                />
              
              </div>    
            </div>

	  </div></div></section>
 

<p>I have often lent heavily on Apache Spark and the SparkSQL APIs for operationalising any type of batch data-processing &lsquo;job&rsquo;, within a production environment where handling fluctuating volumes of data reliably and consistently are on-going business concerns. These batch data-processing jobs may involve nothing more than joining data sources and performing aggregations, or they may apply machine learning models to generate inventory recommendations - regardless of the complexity, this often reduces to defining <a href="https://en.wikipedia.org/wiki/Extract,_transform,_load">Extract, Transform and Load (ETL)</a> jobs. I&rsquo;m a self-proclaimed Pythonista, so I use PySpark for interacting with SparkSQL and for writing and testing all of my ETL scripts.</p>
<p>This post is designed to be read in parallel with the code in the <a href="https://github.com/AlexIoannides/pyspark-example-project"><code>pyspark-template-project</code> GitHub repository</a>. Together, these constitute what I consider to be a &lsquo;best practices&rsquo; approach to writing ETL jobs using Apache Spark and its Python (&lsquo;PySpark&rsquo;) APIs. These &lsquo;best practices&rsquo; have been learnt over several years in-the-field, often the result of hindsight and the quest for continuous improvement. I am also grateful to the various contributors to this project for adding their own wisdom to this endeavour.</p>
<p>I aim to addresses the following topics:</p>
<ul>
<li>how to structure ETL code in such a way that it can be easily tested and debugged;</li>
<li>how to pass configuration parameters to a PySpark job;</li>
<li>how to handle dependencies on other modules and packages; and,</li>
<li>what constitutes a &lsquo;meaningful&rsquo; test for an ETL job.</li>
</ul>
<blockquote>
<h3 id="table-of-contents">Table of Contents</h3>
</blockquote>
<ul>
<li><a href="#pyspark-etl-project-structure">PySpark ETL Project Structure</a></li>
<li><a href="#the-structure-of-an-etl-job">The Structure of an ETL Job</a></li>
<li><a href="#passing-configuration-parameters-to-the-etl-job">Passing Configuration Parameters to the ETL Job</a></li>
<li><a href="#packaging-etl-job-dependencies">Packaging ETL Job Dependencies</a></li>
<li><a href="#running-the-etl-job">Running the ETL job</a></li>
<li><a href="#debugging-spark-jobs-using-start_spark">Debugging Spark Jobs Using start_spark</a></li>
<li><a href="#automated-testing">Automated Testing</a></li>
<li><a href="#managing-project-dependencies-using-pipenv">Managing Project Dependencies using Pipenv</a>
<ul>
<li><a href="#installing-pipenv">Installing Pipenv</a></li>
<li><a href="#installing-this-projects-dependencies">Installing this Projects’ Dependencies</a></li>
<li><a href="#running-python-and-ipython-from-the-projects-virtual-environment">Running Python and IPython from the Project’s Virtual Environment</a></li>
<li><a href="#pipenv-shells">Pipenv Shells</a></li>
<li><a href="#automatic-loading-of-environment-variables">Automatic Loading of Environment Variables</a></li>
</ul>
</li>
<li><a href="#summary">Summary</a></li>
</ul>
<h2 id="pyspark-etl-project-structure">PySpark ETL Project Structure</h2>
<p>The basic project structure is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">root<span style="color:#f92672">/</span>
<span style="color:#f92672">|--</span> configs<span style="color:#f92672">/</span>
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> etl_config.json
 <span style="color:#f92672">|--</span> dependencies<span style="color:#f92672">/</span>
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> logging.py
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> spark.py
 <span style="color:#f92672">|--</span> jobs<span style="color:#f92672">/</span>
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> etl_job.py
 <span style="color:#f92672">|</span>   tests<span style="color:#f92672">/</span>
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> test_data<span style="color:#f92672">/</span>
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> <span style="color:#f92672">|</span> <span style="color:#f92672">--</span> employees<span style="color:#f92672">/</span>
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> <span style="color:#f92672">|</span> <span style="color:#f92672">--</span> employees_report<span style="color:#f92672">/</span>
 <span style="color:#f92672">|</span>   <span style="color:#f92672">|--</span> test_etl_job.py
 <span style="color:#f92672">|</span>   Pipfile
 <span style="color:#f92672">|</span>   Pipfile.lock 
 <span style="color:#f92672">|</span>   build_dependencies.sh
 <span style="color:#f92672">|</span>   packages.zip
</code></pre></div><p>The main Python module containing the ETL job (which will be sent to the Spark cluster), is <code>jobs/etl_job.py</code>. Any external configuration parameters required by <code>etl_job.py</code> are stored in JSON format in <code>configs/etl_config.json</code>. Additional modules that support this job can be kept in the <code>dependencies</code> folder (more on this later). In the project&rsquo;s root we include <code>build_dependencies.sh</code> - a bash script for building these dependencies into a zip-file to be sent to the cluster (<code>packages.zip</code>). Unit test modules are kept in the <code>tests</code> folder and small chunks of representative input and output data, to be use with the tests, are kept in <code>tests/test_data</code> folder.</p>
<h2 id="the-structure-of-an-etl-job">The Structure of an ETL Job</h2>
<p>In order to facilitate easy debugging and testing, we recommend that the &lsquo;Transformation&rsquo; step be isolated from the &lsquo;Extract&rsquo; and &lsquo;Load&rsquo; steps, into it&rsquo;s own function - taking input data arguments in the form of DataFrames and returning the transformed data as a single DataFrame. For example, in the <code>main()</code> job function from <code>jobs/etl_job.py</code> we have,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">data <span style="color:#f92672">=</span> extract_data(<span style="color:#f92672">...</span>)
data_transformed <span style="color:#f92672">=</span> transform_data(data, <span style="color:#f92672">...</span>)
load_data(data_transformed, <span style="color:#f92672">...</span>)
</code></pre></div><p>The code that surrounds the use of the transformation function in the <code>main()</code> job function, is concerned with Extracting the data, passing it to the transformation function and then Loading (or writing) the results to their ultimate destination. Testing is simplified, as mock or test data can be passed to the transformation function and the results explicitly verified, which would not be possible if all of the ETL code resided in <code>main()</code> and referenced production data sources and destinations.</p>
<p>More generally, transformation functions should be designed to be <a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a>. This is a technical way of saying that,</p>
<blockquote>
<p><em>the repeated application of the transformation function to the input data, should have no impact on the fundamental state of output data, until the instance when the input data changes.</em></p>
</blockquote>
<p>One of the key advantages of idempotent ETL jobs, is that they can be set to run repeatedly (e.g. by using <code>cron</code> to trigger the <code>spark-submit</code> command on a pre-defined schedule), rather than having to factor-in potential dependencies on other ETL jobs completing successfully.</p>
<h2 id="passing-configuration-parameters-to-the-etl-job">Passing Configuration Parameters to the ETL Job</h2>
<p>Although it is possible to pass arguments to <code>etl_job.py</code>, as you would for any generic Python module running as a &lsquo;main&rsquo; program  - by specifying them after the module&rsquo;s filename and then parsing these command line arguments - this can get very complicated, <strong>very quickly</strong>, especially when there are lot of parameters (e.g. credentials for multiple databases, table names, SQL snippets, etc.). This also makes debugging the code from within a Python interpreter extremely awkward, as you don&rsquo;t have access to the command line arguments that would ordinarily be passed to the code, when calling it from the command line.</p>
<p>A much more effective solution is to send Spark a separate file - e.g. using the <code>--files configs/etl_config.json</code> flag with <code>spark-submit</code> - containing the configuration in JSON format, which can be parsed into a Python dictionary in one line of code with <code>json.loads(config_file_contents)</code>. Testing the code from within a Python interactive console session is also greatly simplified, as all one has to do to access configuration parameters for testing, is to copy and paste the contents of the file - e.g.,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> json

config <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(<span style="color:#e6db74">&#34;&#34;&#34;{&#34;field&#34;: &#34;value&#34;}&#34;&#34;&#34;</span>)
</code></pre></div><p>This also has the added bonus that the ETL job configuration can be explicitly version controlled within the same project structure, avoiding the risk that configuration parameters escape any type of version control - e.g. because they are passed as arguments in bash scripts written by separate teams, whose responsibility is deploying the code, not writing it.</p>
<p>For the exact details of how the configuration file is located, opened and parsed, please see the <code>start_spark()</code> function in <code>dependencies/spark.py</code> (also discussed in more detail below), which in addition to parsing the configuration file sent to Spark (and returning it as a Python dictionary), also launches the Spark driver program (the application) on the cluster and retrieves the Spark logger at the same time.</p>
<h2 id="packaging-etl-job-dependencies">Packaging ETL Job Dependencies</h2>
<p>In this project, functions that can be used across different ETL jobs are kept in a module called <code>dependencies</code> and referenced in specific job modules using, for example,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> dependencies.spark <span style="color:#f92672">import</span> start_spark
</code></pre></div><p>This package, together with any additional dependencies referenced within it, must be to copied to each Spark node for all jobs that use <code>dependencies</code> to run. This can be achieved in one of several ways:</p>
<ol>
<li>send all dependencies as a <code>zip</code> archive together with the job, using <code>--py-files</code> with Spark submit;</li>
<li>formally package and upload <code>dependencies</code> to somewhere like the <code>PyPI</code> archive (or a private version) and then run <code>pip3 install dependencies</code> on each node; or,</li>
<li>a combination of manually copying new modules (e.g. <code>dependencies</code>) to the Python path of each node and using <code>pip3 install</code> for additional dependencies (e.g. for <code>requests</code>).</li>
</ol>
<p>Option (1) is by far the easiest and most flexible approach, so we will make use of this. To make this task easier, especially when modules such as <code>dependencies</code> have their own downstream dependencies (e.g. the <code>requests</code> package), we have provided the <code>build_dependencies.sh</code> bash script for automating the production of <code>packages.zip</code>, given a list of dependencies documented in <code>Pipfile</code> and managed by the <a href="https://pipenv.readthedocs.io/en/latest/">Pipenv</a> python application (we discuss the use of Pipenv in greater depth below).</p>
<blockquote>
<p>Note, that dependencies (e.g. NumPy) requiring extensions (e.g. C code) to be compiled locally, will have to be installed manually on each node as part of the node setup.</p>
</blockquote>
<h2 id="running-the-etl-job">Running the ETL job</h2>
<p>Assuming that the <code>$ SPARK_HOME</code> environment variable points to your local Spark installation folder, then the ETL job can be run from the project&rsquo;s root directory using the following command from the terminal,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>SPARK_HOME<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>spark<span style="color:#f92672">-</span>submit \
<span style="color:#f92672">--</span>master local[<span style="color:#f92672">*</span>] \
<span style="color:#f92672">--</span>packages <span style="color:#e6db74">&#39;com.some-spark-jar.dependency:1.0.0&#39;</span> \
<span style="color:#f92672">--</span>py<span style="color:#f92672">-</span>files dependencies.zip \
<span style="color:#f92672">--</span>files configs<span style="color:#f92672">/</span>etl_config.json \
jobs<span style="color:#f92672">/</span>etl_job.py
</code></pre></div><p>Briefly, the options supplied serve the following purposes:</p>
<ul>
<li><code>--master local[*]</code> - the address of the Spark cluster to start the job on. If you have a Spark cluster in operation (either in single-executor mode locally, or something larger in the cloud) and want to send the job there, then modify this with the appropriate Spark IP - e.g. <code>spark://the-clusters-ip-address:7077</code>;</li>
<li><code>--packages 'com.some-spark-jar.dependency:1.0.0,...'</code> - Maven coordinates for any JAR dependencies required by the job (e.g. JDBC driver for connecting to a relational database);</li>
<li><code>--files configs/etl_config.json</code> - the (optional) path to any config file that may be required by the ETL job;</li>
<li><code>--py-files packages.zip</code> - archive containing Python dependencies (modules) referenced by the job; and,</li>
<li><code>jobs/etl_job.py</code> - the Python module file containing the ETL job to execute.</li>
</ul>
<p>Full details of all possible options can be found <a href="http://spark.apache.org/docs/latest/submitting-applications.html">here</a>. Note, that we have left some options to be defined within the job (which is actually a Spark application) - e.g. <code>spark.cores.max</code> and <code>spark.executor.memory</code> are defined in the Python script as it is felt that the job should explicitly contain the requests for the required cluster resources.</p>
<h2 id="debugging-spark-jobs-using-start_spark">Debugging Spark Jobs Using <code>start_spark</code></h2>
<p>It is not practical to test and debug Spark jobs by sending them to a cluster using <code>spark-submit</code> and examining stack traces for clues on what went wrong. A more productive workflow is to use an interactive console session (e.g. IPython) or a debugger (e.g. the <code>pdb</code> package in the Python standard library or the Python debugger in Visual Studio Code). In practice, however, it can be hard to test and debug Spark jobs in this way, as they can implicitly rely on arguments that are sent to <code>spark-submit</code>, which are not available in a console or debug session.</p>
<p>We wrote the <code>start_spark</code> function - found in <code>dependencies/spark.py</code> - to facilitate the development of Spark jobs that are aware of the context in which they are being executed - i.e. as <code>spark-submit</code> jobs or within an IPython console, etc. The expected location of the Spark and job configuration parameters required by the job, is contingent on which execution context has been detected. The doscstring for <code>start_spark</code> gives the precise details,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">start_spark</span>(app_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;my_spark_app&#39;</span>, master<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;local[*]&#39;</span>, jar_packages<span style="color:#f92672">=</span>[],
                files<span style="color:#f92672">=</span>[], spark_config<span style="color:#f92672">=</span>{}):
    <span style="color:#e6db74">&#34;&#34;&#34;Start Spark session, get Spark logger and load config files.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Start a Spark session on the worker node and register the Spark
</span><span style="color:#e6db74">    application with the cluster. Note, that only the app_name argument
</span><span style="color:#e6db74">    will apply when this is called from a script sent to spark-submit.
</span><span style="color:#e6db74">    All other arguments exist solely for testing the script from within
</span><span style="color:#e6db74">    an interactive Python console.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    This function also looks for a file ending in &#39;config.json&#39; that
</span><span style="color:#e6db74">    can be sent with the Spark job. If it is found, it is opened,
</span><span style="color:#e6db74">    the contents parsed (assuming it contains valid JSON for the ETL job
</span><span style="color:#e6db74">    configuration), into a dict of ETL job configuration parameters,
</span><span style="color:#e6db74">    which are returned as the last element in the tuple returned by
</span><span style="color:#e6db74">    this function. If the file cannot be found then the return tuple
</span><span style="color:#e6db74">    only contains the Spark session and Spark logger objects and None
</span><span style="color:#e6db74">    for config.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    The function checks the enclosing environment to see if it is being
</span><span style="color:#e6db74">    run from inside an interactive console session or from an
</span><span style="color:#e6db74">    environment which has a `DEBUG` environment varibale set (e.g.
</span><span style="color:#e6db74">    setting `DEBUG=1` as an environment variable as part of a debug
</span><span style="color:#e6db74">    configuration within an IDE such as Visual Studio Code or PyCharm.
</span><span style="color:#e6db74">    In this scenario, the function uses all available function arguments
</span><span style="color:#e6db74">    to start a PySpark driver from the local PySpark package as opposed
</span><span style="color:#e6db74">    to using the spark-submit and Spark cluster defaults. This will also
</span><span style="color:#e6db74">    use local module imports, as opposed to those in the zip archive
</span><span style="color:#e6db74">    sent to spark via the --py-files flag in spark-submit. 
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    Note, if using the local PySpark package on a machine that has the
</span><span style="color:#e6db74">    SPARK_HOME environment variable set to a local install of Spark,
</span><span style="color:#e6db74">    then the versions will need to match as PySpark appears to pick-up
</span><span style="color:#e6db74">    on SPARK_HOME automatically and version conflicts yield errors.
</span><span style="color:#e6db74">
</span><span style="color:#e6db74">    :param app_name: Name of Spark app.
</span><span style="color:#e6db74">    :param master: Cluster connection details (defaults to local[*].
</span><span style="color:#e6db74">    :param jar_packages: List of Spark JAR package names.
</span><span style="color:#e6db74">    :param files: List of files to send to Spark cluster (master and
</span><span style="color:#e6db74">        workers).
</span><span style="color:#e6db74">    :param spark_config: Dictionary of config key-value pairs.
</span><span style="color:#e6db74">    :return: A tuple of references to the Spark session, logger and
</span><span style="color:#e6db74">        config dict (only if available).
</span><span style="color:#e6db74">    &#34;&#34;&#34;</span>

    <span style="color:#75715e"># ...</span>

    <span style="color:#66d9ef">return</span> spark_sess, spark_logger, config_dict
</code></pre></div><p>For example, the following code snippet,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">spark, log, config <span style="color:#f92672">=</span> start_spark(
    app_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;my_etl_job&#39;</span>,
    jar_packages<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;com.somesparkjar.dependency:1.0.0&#39;</span>],
    files<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;configs/etl_config.json&#39;</span>])
</code></pre></div><p>Will use the arguments provided to <code>start_spark</code> to setup the Spark job if executed from an interactive console session or debugger, but will look for the same arguments sent via <code>spark-submit</code> if that is how the job has been executed.</p>
<blockquote>
<p>Note, if you are using the local PySpark package - e.g. if running from an interactive console session or debugger - on a machine that also has the <code>SPARK_HOME</code> environment variable set to a local install of Spark, then the two versions will need to match as PySpark appears to pick-up on SPARK_HOME automatically, with version conflicts leading to (unintuitive) errors.</p>
</blockquote>
<h2 id="automated-testing">Automated Testing</h2>
<p>In order to test with Spark, we use the <code>pyspark</code> Python package, which is bundled with the Spark JARs required to programmatically start-up and tear-down a local Spark instance, on a per-test-suite basis (we recommend using the <code>setUp</code> and <code>tearDown</code> methods in <code>unittest.TestCase</code> to do this once per test-suite). Note, that using <code>pyspark</code> to run Spark is an alternative way of developing with Spark as opposed to using the PySpark shell or <code>spark-submit</code>.</p>
<p>Given that we have chosen to structure our ETL jobs in such a way as to isolate the &lsquo;Transformation&rsquo; step into its own function (see &lsquo;Structure of an ETL job&rsquo; above), we are free to feed it a small slice of &lsquo;real-world&rsquo; production data that has been persisted locally - e.g. in <code>tests/test_data</code> or some easily accessible network directory - and check it against known results (e.g. computed manually or interactively within a Python interactive console session), as demonstrated in this extract from <code>tests/test_etl_job.py</code>,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># assemble</span>
input_data <span style="color:#f92672">=</span> (
    self<span style="color:#f92672">.</span>spark
    <span style="color:#f92672">.</span>read
    <span style="color:#f92672">.</span>parquet(self<span style="color:#f92672">.</span>test_data_path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;employees&#39;</span>))

expected_data <span style="color:#f92672">=</span> (
    self<span style="color:#f92672">.</span>spark
    <span style="color:#f92672">.</span>read
    <span style="color:#f92672">.</span>parquet(self<span style="color:#f92672">.</span>test_data_path <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;employees_report&#39;</span>))

expected_cols <span style="color:#f92672">=</span> len(expected_data<span style="color:#f92672">.</span>columns)
expected_rows <span style="color:#f92672">=</span> expected_data<span style="color:#f92672">.</span>count()
expected_avg_steps <span style="color:#f92672">=</span> (
    expected_data
    <span style="color:#f92672">.</span>agg(mean(<span style="color:#e6db74">&#39;steps_to_desk&#39;</span>)<span style="color:#f92672">.</span>alias(<span style="color:#e6db74">&#39;avg_steps_to_desk&#39;</span>))
    <span style="color:#f92672">.</span>collect()[<span style="color:#ae81ff">0</span>]
    [<span style="color:#e6db74">&#39;avg_steps_to_desk&#39;</span>])

<span style="color:#75715e"># act</span>
data_transformed <span style="color:#f92672">=</span> transform_data(input_data, <span style="color:#ae81ff">21</span>)

cols <span style="color:#f92672">=</span> len(expected_data<span style="color:#f92672">.</span>columns)
rows <span style="color:#f92672">=</span> expected_data<span style="color:#f92672">.</span>count()
avg_steps <span style="color:#f92672">=</span> (
    expected_data
    <span style="color:#f92672">.</span>agg(mean(<span style="color:#e6db74">&#39;steps_to_desk&#39;</span>)<span style="color:#f92672">.</span>alias(<span style="color:#e6db74">&#39;avg_steps_to_desk&#39;</span>))
    <span style="color:#f92672">.</span>collect()[<span style="color:#ae81ff">0</span>]
    [<span style="color:#e6db74">&#39;avg_steps_to_desk&#39;</span>])

<span style="color:#75715e"># assert</span>
self<span style="color:#f92672">.</span>assertEqual(expected_cols, cols)
self<span style="color:#f92672">.</span>assertEqual(expected_rows, rows)
self<span style="color:#f92672">.</span>assertEqual(expected_avg_steps, avg_steps)
self<span style="color:#f92672">.</span>assertTrue([col <span style="color:#f92672">in</span> expected_data<span style="color:#f92672">.</span>columns
                 <span style="color:#66d9ef">for</span> col <span style="color:#f92672">in</span> data_transformed<span style="color:#f92672">.</span>columns])
</code></pre></div><p>To execute the example unit test for this project run,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>pipenv run python <span style="color:#f92672">-</span>m unittest tests<span style="color:#f92672">/</span>test_<span style="color:#f92672">*</span>.py
</code></pre></div><p>If you&rsquo;re wondering what the <code>pipenv</code> command is, then read the next section.</p>
<h2 id="managing-project-dependencies-using-pipenv">Managing Project Dependencies using Pipenv</h2>
<p>We use <a href="https://docs.pipenv.org">Pipenv</a> for managing project dependencies and Python environments (i.e. virtual environments). All direct packages dependencies (e.g. NumPy may be used in a User Defined Function), as well as all the packages used during development (e.g. PySpark, flake8 for code linting, IPython for interactive console sessions, etc.), are described in the <code>Pipfile</code>. Their <strong>precise</strong> downstream dependencies are described and frozen in <code>Pipfile.lock</code> (generated automatically by Pipenv, given a Pipfile).</p>
<h3 id="installing-pipenv">Installing Pipenv</h3>
<p>To get started with Pipenv, first of all download it - assuming that there is a global version of Python available on your system and on the PATH, then this can be achieved by running the following command,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>pip3 install pipenv
</code></pre></div><p>Pipenv is also available to install from many non-Python package managers. For example, on OS X it can be installed using the <a href="https://brew.sh">Homebrew</a> package manager, with the following terminal command,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>brew install pipenv
</code></pre></div><p>For more information, including advanced configuration options, see the <a href="https://docs.pipenv.org">official Pipenv documentation</a>.</p>
<h3 id="installing-this-projects-dependencies">Installing this Projects&rsquo; Dependencies</h3>
<p>Make sure that you&rsquo;re in the project&rsquo;s root directory (the same one in which the <code>Pipfile</code> resides), and then run,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>pipenv install <span style="color:#f92672">--</span>dev
</code></pre></div><p>This will install all of the direct project dependencies as well as the development dependencies (the latter a consequence of the <code>--dev</code> flag).</p>
<h3 id="running-python-and-ipython-from-the-projects-virtual-environment">Running Python and IPython from the Project&rsquo;s Virtual Environment</h3>
<p>In order to continue development in a Python environment that precisely mimics the one the project was initially developed with, use Pipenv from the command line as follows,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>pipenv run python3
</code></pre></div><p>The <code>python3</code> command could just as well be <code>ipython3</code>, for example,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>pipenv run ipython
</code></pre></div><p>This will fire-up an IPython console session <em>where the default Python 3 kernel includes all of the direct and development project dependencies</em> - this is our preference.</p>
<h3 id="pipenv-shells">Pipenv Shells</h3>
<p>Prepending <code>pipenv</code> to every command you want to run within the context of your Pipenv-managed virtual environment can get very tedious. This can be avoided by entering into a Pipenv-managed shell,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$ </span>pipenv shell
</code></pre></div><p>This is equivalent to &lsquo;activating&rsquo; the virtual environment; any command will now be executed within the virtual environment. Use <code>exit</code> to leave the shell session.</p>
<h3 id="automatic-loading-of-environment-variables">Automatic Loading of Environment Variables</h3>
<p>Pipenv will automatically pick-up and load any environment variables declared in the <code>.env</code> file, located in the package&rsquo;s root directory. For example, adding,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">SPARK_HOME<span style="color:#f92672">=</span>applications<span style="color:#f92672">/</span>spark<span style="color:#ae81ff">-2.3.1</span><span style="color:#f92672">/</span>bin
DEBUG<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</code></pre></div><p>Will enable access to these variables within any Python program -e.g. via a call to <code>os.environ['SPARK_HOME']</code>. Note, that if any security credentials are placed here, then this file <strong>must</strong> be removed from source control - i.e. add <code>.env</code> to the <code>.gitignore</code> file to prevent potential security risks.</p>
<h2 id="summary">Summary</h2>
<p>The workflow described above, together with the <a href="https://github.com/AlexIoannides/pyspark-example-project">accompanying Python project</a>, represents a stable foundation for writing robust ETL jobs, regardless of their complexity and regardless of how the jobs are being executed - e.g. via use of <code>cron</code> or more sophisticated workflow automation tools, such as <a href="https://airflow.apache.org">Airflow</a>. I am always interested in collating and integrating more &lsquo;best practices&rsquo; - if you have any, please submit them <a href="https://github.com/AlexIoannides/pyspark-example-project/issues">here</a>.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

      <div>
        <br>
        <div>
          <h5 class="title is-small">Share to social media</h5>
          <div>
            <a class="share share-network-twitter" style="background-color:#008080;"><i class="fab fah fa-lg fa-twitter"></i><span>Twitter</span></a>
            <a class="share share-network-facebook" style="background-color:#1877f2;"><i class="fab fah fa-lg fa-facebook-f"></i><span>Facebook</span></a>
            <a class="share share-network-linkedin" style="background-color:#2B1B17;"><i class="fab fah fa-lg fa-linkedin"></i><span>LinkedIn</span></a>
            <a class="share share-network-hackernews" style="background-color:#008000"><i class="fab fah fa-lg fa-hacker-news"></i><span>HackerNews</span></a>
            <a class="share share-network-pinterest" style="background-color:#bd081c;"><i class="fab fah fa-lg fa-pinterest"></i><span>Pinterest</span></a>
            <a class="share share-network-pocket" style="background-color:#7F38EC;"><i class="fab fah fa-lg fa-get-pocket"></i><span>Pocket</span></a>
            <a class="share share-network-email" style="background-color:#333333;"><i class="far fah fa-lg fa-envelope"></i><span>Email</span></a>
            <a class="share share-network-flipboard" style="background-color: #837E7C;"><i class="fab fah fa-lg fa-flipboard"></i><span>Flipboard</span></a>
            <a class="share share-network-quora" style="background-color:#808000;"><i class="fab fah fa-lg fa-quora"></i><span>Quora</span></a>
            <a class="share share-network-reddit" style="background-color: #581845
            ;"><i class="fab fah fa-lg fa-reddit-alien"></i><span>Reddit</span></a>
            <a class="share share-network-telegram" style="background-color:#000080;"><i class="fab fah fa-lg fa-telegram-plane"></i><span>Telegram</span></a>
            <a class="share share-network-whatsapp" style="background-color:#E55451;"><i class="fab fah fa-lg fa-whatsapp"></i><span>Whatsapp</span></a>
            <a class="share share-network-sms" style="background-color:#513B1C;"><i class="far fah fa-lg fa-comment-dots"></i><span>SMS</span></a>
          </div>
        </div>
      </div>
      <div class="comments">
        <div id="disqus_thread" pageConfig="[object Object]"></div>
      </div>
      
      <div id="disqus_thread"></div>
      <script>
          

          

          (function() { 
          var d = document, s = d.createElement('script');
          s.src = 'https://engineer-dancun-personal-blog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      
      <br><br><br>
      <footer>
        &copy;  
        Powered by <a href="https://github.com/gohugoio/hugo" target="_blank">Hugo
      </footer>
      <script type="application/ld+json">
        {
          "@context" : "http://schema.org",
          "@type" : "Blog",
          "name": " Engineer Dancun ",
          "url" : "https://devopsengineerdan.github.io",
          "image": "./static/avatar.jpg",
          "description": "Software Engineer and Researcher"
        }
        </script>
        <script id="dsq-count-scr" src="//engineer-dancun.disqus.com/count.js" async></script>
    </main>

   <!-- End #main 

    <div id="preloader"></div>
    <a
      href="#"
      class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a> -->

    <!-- Vendor JS Files -->
    <script src="https://devopsengineerdan.github.io/assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/aos/aos.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/swiper/swiper-bundle.min.js"></script>
    <!-- <script src="https://devopsengineerdan.github.io/assets/vendor/waypoints/noframework.waypoints.js"></script> -->
	  
    <!-- Template Main JS File -->
    <script src="https://devopsengineerdan.github.io/assets/js/main.js"></script>

    
  </body>
</html>
