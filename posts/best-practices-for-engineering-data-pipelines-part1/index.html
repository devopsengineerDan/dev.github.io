<!doctype html>
<html lang="en-us">
  <head>
    <title>Best Practices for Engineering ML Pipelines - Part 1 // Engineer Dancun</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.68.3" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Dancun Manyinsa" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://devopsengineerdan.github.io/css/main.min.d5ed8558bcfb3aab1e3d1790fb902decbac1f989a0d27aa3b2a2320773186707.css" />
    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Best Practices for Engineering ML Pipelines - Part 1"/>
<meta name="twitter:description" content="The is the first in a series of articles demonstrating how to engineer a machine learning pipeline and deploy it to a production environment. We’re going to assume that a solution to a ML problem already exists within a Jupyter notebook, and that our task is to engineer this solution into an operational ML system, that can train a model, serve it via a web API and automatically repeat this process on a schedule when new data is made available."/>

    <meta property="og:title" content="Best Practices for Engineering ML Pipelines - Part 1" />
<meta property="og:description" content="The is the first in a series of articles demonstrating how to engineer a machine learning pipeline and deploy it to a production environment. We’re going to assume that a solution to a ML problem already exists within a Jupyter notebook, and that our task is to engineer this solution into an operational ML system, that can train a model, serve it via a web API and automatically repeat this process on a schedule when new data is made available." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://devopsengineerdan.github.io/posts/best-practices-for-engineering-data-pipelines-part1/" />
<meta property="article:published_time" content="2023-09-09T13:29:58+03:00" />
<meta property="article:modified_time" content="2023-09-09T13:29:58+03:00" />


	  <!-- Favicons 
    <link href="https://devopsengineerdan.github.io/assets/img/apple-touch-icon.png" rel="apple-touch-icon" />

    <!-- Google Fonts 
    <link href="https://devopsengineerdan.github.io/assets/vendor/google/css/icons.css" rel="stylesheet" />

<!-- Vendor CSS Files   -->
   <link href="https://devopsengineerdan.github.io/assets/vendor/aos/aos.css" rel="stylesheet" /> 
 <!--    <link href="https://devopsengineerdan.github.io/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" /> -->
  <!--  <link
      href="https://devopsengineerdan.github.io/assets/vendor/glightbox/css/glightbox.min.css"
      rel="stylesheet"
    />
    <link href="https://devopsengineerdan.github.io/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet" /> 


    <!-- Template Main CSS File  
    <link href="https://devopsengineerdan.github.io/assets/assets/css/style.css" rel="stylesheet" />   -->




<style>
  .image {
    width: 100%;
    position: relative;  
  }
	
  .image_img {
    display: block;
  }
	
  .image_overlay {
    height: 100%;
    width: 100%;
    top: 0;
    left: 0;
    position: absolute;
    background: rgba(0,0,0, 0.6);
    colour: #ffffff;
    font-family: "Quicksand", sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    opacity: 0;	  
    transition: opacity 0.6s;
  }
	
  .image_title {
    font-size: 2em;
    font-weight: bold;
  }

  .image_description {
    font-size: 1.25em;
    margin-top: 0.25em;
  }
	
  .image_overlay {
    opacity: 0.5;
  }
	
 .image_overlay:hover {
    opacity: 1;
  }

 .image_overlay:hover > * {
    transform: translateY(0px);
  }

  .image_overlay > * {
    transform: translateY(25px);
    transition: transform 0.6s;
  }


</style>


	  
  </head>
  <body>
    <header class="app-header">
      <a href="https://devopsengineerdan.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Dancun Manyinsa" /></a>
      <h1>Engineer Dancun</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="https://devopsengineerdan.github.io/">Home</a>
             - 
          
          <a class="app-header-menu-item" href="https://devopsengineerdan.github.io/tags/">Tags</a>
             - 
          
          <a class="app-header-menu-item" href="https://devopsengineerdan.github.io/about/">About</a>
      </nav>
      <p>Software Engineer, Researcher(AI and Quantum Science), and Habitual Quant</p>
      <div class="app-header-social">
        
          <a href="https://www.github.com/DancunManyinsa" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://www.linkedin.com/in/dancun-manyinsa-42518a17b/" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>Linkedin</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
          <a href="mailto:dancunmoruri@gmail.com" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-link">
  <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
  <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Best Practices for Engineering ML Pipelines - Part 1</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Sep 9, 2023
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          13 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://devopsengineerdan.github.io/tags/python/">python</a>
        </div>
      </div>
    </header>
    <div class="post-content" id="main">
      <hr>


	 
	    
       <!-- ======= Portfolio Section ======= -->
      <section id="portfolio" class="portfolio">
        <div class="container" data-aos="fade-up">
          <div
            class="row portfolio-container"
            data-aos="fade-up"
            data-aos-delay="200"
          >
            <div class="col-lg-4 col-md-6 portfolio-item filter-app">
              <div class="portfolio-wrap">
               
              <p><img src="https://github.com/devopsengineerDan/engineer-dancun-personal-blog/assets/48592378/4eb0599c-7062-4e5a-84cf-b03055e87bf1" alt="pipelines-logo"    class="img-fluid"
                  alt=""></p>
              </div>    
            </div>

	  </div></div></section>

	    

<p>The is the first in a series of articles demonstrating how to engineer a machine learning pipeline and deploy it to a production environment. We’re going to assume that a solution to a ML problem already exists within a Jupyter notebook, and that our task is to engineer this solution into an operational ML system, that can train a model, serve it via a web API and automatically repeat this process on a schedule when new data is made available.</p>
<p>The focus will be on software engineering and DevOps, as applied to ML, with an emphasis on ‘best practices’. All of the code developed in each part of this project, is available on <a href="https://github.com/bodywork-ml/ml-pipeline-engineering">GitHub</a>, with a dedicated branch for each part, so you can explore the code in its various stages of development.</p>
<p>This first part is focused on how to setup a ML pipeline engineering project and covers:</p>
<ul>
<li>Basic solution architecture.</li>
<li>How to structure the codebase (and repo).</li>
<li>Setting-up automated testing and static code analysis tools.</li>
<li>Making an initial “”Hello, Production” deployment.</li>
<li>Configuring a CI/CD pipeline.</li>
</ul>
<blockquote>
<h3 id="table-of-contents">Table of Contents</h3>
</blockquote>
<ul>
<li><a href="#reviewing-the-business-problem">Reviewing the Business Problem</a></li>
<li><a href="#reviewing-the-technical-problem">Reviewing the Technical Problem</a>
<ul>
<li><a href="#example-prediction-request-json">Example Prediction Request JSON</a></li>
<li><a href="#example-prediction-response-json">Example Prediction Response JSON</a></li>
</ul>
</li>
<li><a href="#solution-architecture">Solution Architecture</a></li>
<li><a href="#structuring-the-pipeline-project">Structuring the Pipeline Project</a></li>
<li><a href="#setting-up-the-local-dev-environment">Setting-Up the Local Dev Environment</a></li>
<li><a href="#setting-up-the-testing-framework">Setting-Up the Testing Framework</a>
<ul>
<li><a href="#using-tox-for-test-automation">Using Tox for Test Automation</a></li>
<li><a href="#testing-manually">Testing Manually</a></li>
</ul>
</li>
<li><a href="#creating-a-deployment-environment">Creating a Deployment Environment</a></li>
<li><a href="#configuring-cicd">Configuring CI/CD</a></li>
<li><a href="#wrapping-up">Wrapping-Up</a></li>
</ul>
<h2 id="reviewing-the-business-problem">Reviewing the Business Problem</h2>
<p>A manufacturer of industrial spare-parts wants the ability to give its customers an estimate for the time it could take to dispatch an order. This depends on how many existing orders have yet to be processed, such that customers ordering late on a busy day can encounter unexpected delays, which sometimes leads to complaints; this is an exercise in keeping customers happy by managing their expectations.</p>
<p>Orders are placed on a B2B eCommerce platform, that is developed and maintained by the manufacturer’s in-house software engineering team. The product manager for the platform wants the estimated dispatch time to be presented to the customer (through the UI), before they place an order.</p>
<h2 id="reviewing-the-technical-problem">Reviewing the Technical Problem</h2>
<p>A data scientist has worked on this (regression) task and has handed us the <a href="https://github.com/bodywork-ml/ml-pipeline-engineering/blob/master/notebooks/time_to_dispatch_model.ipynb">Jupyter notebook</a> containing their solution. They have concluded that optimal performance can be achieved by training on the preceding week’s orders data, so the model will have to be re-trained and redeployed on a weekly basis.</p>
<p>At the end of each week, the data engineering team deliver a new tranche of training data, as a CSV file on cloud object storage (AWS S3). The platform engineering team want access to order-dispatch estimates via a web service with a simple REST API, and have supplied us with an example request and response (reproduced below). The platform and data engineering teams both deploy their systems and services to AWS, and we too are required to deploy our solution (the pipeline) to AWS.</p>
<h3 id="example-prediction-request-json">Example Prediction Request JSON</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;product_code&#34;</span>: <span style="color:#e6db74">&#34;SKU001&#34;</span>,
    <span style="color:#f92672">&#34;orders_placed&#34;</span>: <span style="color:#ae81ff">112</span>
}
</code></pre></div><h3 id="example-prediction-response-json">Example Prediction Response JSON</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#f92672">&#34;est_hours_to_dispatch&#34;</span>: <span style="color:#ae81ff">5.321</span>,
    <span style="color:#f92672">&#34;model_version&#34;</span>: <span style="color:#e6db74">&#34;0.1&#34;</span>
}
</code></pre></div><h2 id="solution-architecture">Solution Architecture</h2>

 <!-- ======= Portfolio Section ======= -->
      <section id="portfolio" class="portfolio">
        <div class="container" data-aos="fade-up">
          <div
            class="row portfolio-container"
            data-aos="fade-up"
            data-aos-delay="200"
          >
            <div class="col-lg-4 col-md-6 portfolio-item filter-app">
              <div class="portfolio-wrap">


		      
<div class="image">
	<img height=100%; width=100%; class="image_img" src="https://github.com/devopsengineerDan/engineer-dancun-personal-blog/assets/48592378/2ae81780-080a-46d0-a876-f2915d6752c3" alt="scope_and_context"    class="img-fluid"
                  alt="">
	
<div class="image_overlay">
    <div class="image_title">AWS</div>
  <p class="image_description">Solution Architecture Workflow</p>
    </div>
   </div>        
  


		      
            
              </div>    
            </div>

	  </div></div></section>


	    

<p>The architecture for the target solution is outlined above - the workflow is as follows:</p>
<ul>
<li>Every Friday night at 2300 a new batch of training data is added to an S3 bucket in CSV format.</li>
<li>After the new data arrives, a pipeline needs to be triggered that will train a new model and then deploy it, tearing-down the previous prediction service in the process (with zero downtime in-between).</li>
</ul>
<p>The pipeline will be split into two stages, each of which will be implemented as an executable Python module:</p>
<ul>
<li><strong>train model</strong> - downloads the latest tranche of data from object storage, trains a model and then persists the model to object storage.</li>
<li><strong>serve model</strong> - downloads the latest trained model and then starts a web server that exposes a REST API endpoint that serves requests for dispatch duration predictions.</li>
</ul>
<p>The pipeline will be deployed in containers to AWS EKS (managed Kubernetes cluster), using <a href="https://bodywork.readthedocs.io/en/latest/">Bodywork</a>.</p>
<h2 id="structuring-the-pipeline-project">Structuring the Pipeline Project</h2>
<p>The files in the <a href="https://github.com/bodywork-ml/ml-pipeline-engineering">project’s git repository</a> are organised as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">root<span style="color:#f92672">/</span>
 <span style="color:#f92672">|--</span> .circleci<span style="color:#f92672">/</span>
     <span style="color:#f92672">|--</span> config.yml
 <span style="color:#f92672">|--</span> notebooks<span style="color:#f92672">/</span>    
     <span style="color:#f92672">|--</span> time_to_dispatch_model.ipynb
     <span style="color:#f92672">|--</span> requirements_nb.txt
 <span style="color:#f92672">|--</span> pipeline<span style="color:#f92672">/</span>
     <span style="color:#f92672">|--</span> __init__.py
     <span style="color:#f92672">|--</span> serve_model.py
     <span style="color:#f92672">|--</span> train_model.py
     <span style="color:#f92672">|--</span> utils.py
 <span style="color:#f92672">|--</span> tests<span style="color:#f92672">/</span>
     <span style="color:#f92672">|--</span> __init__.py
	 <span style="color:#f92672">|--</span> test_train_model.py
     <span style="color:#f92672">|--</span> test_serve_model.py
 <span style="color:#f92672">|--</span> requirements_cicd.txt
 <span style="color:#f92672">|--</span> requirements_pipe.txt
 <span style="color:#f92672">|--</span> flake8.ini
 <span style="color:#f92672">|--</span> mypy.ini
 <span style="color:#f92672">|--</span> tox.ini
 <span style="color:#f92672">|--</span> bodywork.yaml
</code></pre></div><ul>
<li><code>.circleci/config.yml</code> contains the configuration for the project’s CI/CD pipeline (using <a href="https://circleci.com">CircleCI</a>). We&rsquo;ll discuss in more depth later on.</li>
<li><code>notebooks/*</code> - has all of the Jupyter notebooks detailing the ML solution to the business problem.</li>
<li><code>pipeline/*</code> has all Python modules that define the pipeline.</li>
<li><code>tests/*</code> contains Python modules defining automated tests for the pipeline.</li>
<li><code>requirements_cicd.txt</code> lists the Python packages required by the CI/CD pipeline - e.g. for running tests and deploying the pipeline.</li>
<li><code>requirements_pipe.txt</code> lists the Python packages required by the pipeline - e.g. Scikit-Learn, FastAPI, etc.</li>
<li><code>flake8.ini</code> &amp; <code>mypy.ini</code> are configuration files for <a href="https://flake8.pycqa.org/en/latest/#">Flake8</a> code style enforcement and <a href="https://mypy.readthedocs.io/en/stable/">MyPy</a> static type checking.</li>
<li><code>tox.ini</code> provides configuration for the <a href="https://tox.readthedocs.io/en/latest/index.html">Tox</a> test automation framework.</li>
<li><code>bodywork.yaml</code> is the <a href="https://bodywork.readthedocs.io/en/latest/">Bodywork</a> deployment configuration file.</li>
</ul>
<h2 id="setting-up-the-local-dev-environment">Setting-Up the Local Dev Environment</h2>
<p>We’ve split the various Python package requirements into separate files:</p>
<ul>
<li><code>requirements_pipe.txt</code> contains the packages required by the pipeline.</li>
<li><code>requirements_cicd.txt</code> contains the packages required by the CICD pipeline.</li>
<li><code>notebooks/requirements_nb.txt</code> contains the package required to run the notebook.</li>
</ul>
<p>We’re planning to deploy the pipeline using Bodywork, which currently targets the Python 3.9 runtime, so we create a Python 3.9 virtual environment in which to install all requirements.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> python3.9 <span style="color:#f92672">-</span>m venv .venv
<span style="color:#f92672">$</span> source .venv<span style="color:#f92672">/</span>bin<span style="color:#f92672">/</span>activate
<span style="color:#f92672">$</span> pip install <span style="color:#f92672">-</span>r requirements_pipe.txt
<span style="color:#f92672">$</span> pip install <span style="color:#f92672">-</span>r requirements_cicd.txt
<span style="color:#f92672">$</span> pip install <span style="color:#f92672">-</span>r requirements_nb.txt
</code></pre></div><h2 id="setting-up-the-testing-framework">Setting-Up the Testing Framework</h2>
<p>We’re going to use <a href="https://docs.pytest.org/en/6.2.x/">pytest</a> to support test development and we’re going to run them via the <a href="https://tox.readthedocs.io/en/latest/index.html">Tox</a> test automation framework. The best way to get this operational, is to write some skeleton code for the pipeline that can be covered by a couple of basic tests. For example, at a trivial level the  <code>train_model.py</code> batch job should provide us with some basic logs, whose existence we can test for in <code>test_train_model.py</code>. Taking a Test-Driven Development (TDD) approach, we start with the test in <code>test_train_model.py</code>,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> _pytest.logging <span style="color:#f92672">import</span> LogCaptureFixture

<span style="color:#f92672">from</span> pipeline.train_model <span style="color:#f92672">import</span> main


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_main_execution</span>(caplog: LogCaptureFixture):
    main()
    logs <span style="color:#f92672">=</span> caplog<span style="color:#f92672">.</span>text
    <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;Starting train-model stage.&#34;</span> <span style="color:#f92672">in</span> logs
</code></pre></div><p>Where we use pytest’s <code>caplog</code> fixture to capture logs messages. We now provide the implementation in <code>train_model.py</code>,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> pipeline.utils <span style="color:#f92672">import</span> configure_logger

log <span style="color:#f92672">=</span> configure_logger()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">main</span>() <span style="color:#f92672">-&gt;</span> None:
    log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;Starting train-model stage.&#34;</span>)


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    main()
</code></pre></div><p>Where <code>configure_logger</code> configures a Python logger that will be common to both <code>train_model.py</code> and <code>serve_model.py</code>.</p>
<p>Similarly for the  <code>serve_model.py</code> module, we can write a trivial test for the REST API endpoint in <code>test_serve_model.py</code>,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> fastapi.testclient <span style="color:#f92672">import</span> TestClient

<span style="color:#f92672">from</span> pipeline.serve_model <span style="color:#f92672">import</span> app

test_client <span style="color:#f92672">=</span> TestClient(app)


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_web_api_returns_valid_response_given_valid_data</span>():
    prediction_request <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;product_code&#34;</span>: <span style="color:#e6db74">&#34;SKU001&#34;</span>, <span style="color:#e6db74">&#34;orders_placed&#34;</span>: <span style="color:#ae81ff">100</span>}
    prediction_response <span style="color:#f92672">=</span> test_client<span style="color:#f92672">.</span>post(
        <span style="color:#e6db74">&#34;/api/v0.1/time_to_dispatch&#34;</span>, json<span style="color:#f92672">=</span>prediction_request
    )
    <span style="color:#66d9ef">assert</span> prediction_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">200</span>
    <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;est_hours_to_dispatch&#34;</span> <span style="color:#f92672">in</span> prediction_response<span style="color:#f92672">.</span>json()<span style="color:#f92672">.</span>keys()
    <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;model_version&#34;</span> <span style="color:#f92672">in</span> prediction_response<span style="color:#f92672">.</span>json()<span style="color:#f92672">.</span>keys()


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">test_web_api_returns_error_code_given_invalid_data</span>():
    prediction_request <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;product_code&#34;</span>: <span style="color:#e6db74">&#34;SKU001&#34;</span>, <span style="color:#e6db74">&#34;foo&#34;</span>: <span style="color:#ae81ff">100</span>}
    prediction_response <span style="color:#f92672">=</span> test_client<span style="color:#f92672">.</span>post(
        <span style="color:#e6db74">&#34;/api/v0.1/time_to_dispatch&#34;</span>, json<span style="color:#f92672">=</span>prediction_request
    )
    <span style="color:#66d9ef">assert</span> prediction_response<span style="color:#f92672">.</span>status_code <span style="color:#f92672">==</span> <span style="color:#ae81ff">422</span>
    <span style="color:#66d9ef">assert</span> <span style="color:#e6db74">&#34;value_error.missing&#34;</span> <span style="color:#f92672">in</span> prediction_response<span style="color:#f92672">.</span>text
</code></pre></div><p>This loads the FastAPI test client and uses it to verify that sending a request with valid data results in a response with a HTTP status code of <code>200</code>, but sending invalid data results in a HTTP <code>422</code> error (see <a href="https://httpstatuses.com">this</a> for more information on HTTP status codes). In <code>serve_model.py</code> we implement the code to satisfy these tests,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> typing <span style="color:#f92672">import</span> Dict, Union

<span style="color:#f92672">import</span> uvicorn
<span style="color:#f92672">from</span> fastapi <span style="color:#f92672">import</span> FastAPI, status
<span style="color:#f92672">from</span> pydantic <span style="color:#f92672">import</span> BaseModel

app <span style="color:#f92672">=</span> FastAPI(debug<span style="color:#f92672">=</span>False)


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Data</span>(BaseModel):
    product_code: str
    orders_placed: float


<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Prediction</span>(BaseModel):
    est_hours_to_dispatch: float
    model_version: str


<span style="color:#a6e22e">@app.post</span>(
    <span style="color:#e6db74">&#34;/api/v0.1/time_to_dispatch&#34;</span>,
    status_code<span style="color:#f92672">=</span>status<span style="color:#f92672">.</span>HTTP_200_OK,
    response_model<span style="color:#f92672">=</span>Prediction,
)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">time_to_dispatch</span>(data: Data) <span style="color:#f92672">-&gt;</span> Dict[str, Union[str, float]]:
    <span style="color:#66d9ef">return</span> {<span style="color:#e6db74">&#34;est_hours_to_dispatch&#34;</span>: <span style="color:#ae81ff">1.0</span>, <span style="color:#e6db74">&#34;model_version&#34;</span>: <span style="color:#e6db74">&#34;0.1&#34;</span>}


<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
    uvicorn<span style="color:#f92672">.</span>run(app, host<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.0.0.0&#34;</span>, workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</code></pre></div><p>If you’re unfamiliar with how FastAPI uses Python type hints and <a href="https://pydantic-docs.helpmanual.io">Pydantic</a> to define JSON schema, then take a look at the <a href="https://fastapi.tiangolo.com/python-types/">FastAPI docs</a>.</p>
<p>You can run all tests in the <code>tests</code> folder using,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> pytest
</code></pre></div><p>Or isolate a specific test using the <code>-k</code> flag, for example,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> pytest <span style="color:#f92672">-</span>k test_web_api_returns_valid_response_given_valid_data
</code></pre></div><h3 id="using-tox-for-test-automation">Using Tox for Test Automation</h3>
<p><a href="https://tox.readthedocs.io/en/latest/index.html">Tox</a> is a test automation framework that helps to manage groups of tests, together with isolated environments in which to run them. Configuration for Tox is defined in <code>tox.ini</code> , which is reproduced below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ini" data-lang="ini"><span style="color:#66d9ef">[tox]</span>
<span style="color:#a6e22e">envlist</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">{py39}_{unit_and_functional_tests,static_code_analysis}</span>

<span style="color:#66d9ef">[testenv]</span>
<span style="color:#a6e22e">skip_install</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">true</span>
<span style="color:#a6e22e">deps</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">
</span><span style="color:#e6db74">    -rrequirements_cicd.txt
</span><span style="color:#e6db74">    -rrequirements_pipe.txt</span>
<span style="color:#a6e22e">commands</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">
</span><span style="color:#e6db74">    unit_and_functional_tests: pytest tests/ --disable-warnings {posargs}
</span><span style="color:#e6db74">    static_code_analysis: mypy --config-file mypy.ini
</span><span style="color:#e6db74">    static_code_analysis: flake8 --config flake8.ini pipeline</span>
</code></pre></div><p>Calling Tox from command line,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> tox
</code></pre></div><p>Will run every set of tests - those defined in the commands tagged with <code>unit_and_functional</code> and <code>static_code_analysis</code> - for every chosen environment, which in this case is just Python 3.9 (<code>py39</code>). This environment will have none of the environment variables or commands that are present in the local shell, unless they’ve been specified (we haven’t), and can only use the packages specified in <code>requirements_cicd.txt</code> and <code>requirements_pipe.txt</code>. Individual test-environment pairs can be executed using the <code>-e</code> flag - for example,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> tox <span style="color:#f92672">-</span>e py39_static_code_analysis
</code></pre></div><p>Will only run Flake8 and MyPy (static code analysis tools) and leave out the unit and functional tests. For more information on working with Tox, see the <a href="https://tox.readthedocs.io">documentation</a>.</p>
<h3 id="testing-manually">Testing Manually</h3>
<p>Sometimes you just need to test on a <em>ad hoc</em> basis, by running the modules, setting breakpoints, etc. You can run the batch job in <code>train_model.py</code> using,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> python <span style="color:#f92672">-</span>m pipeline.train_model
</code></pre></div><p>Which should print the following to stdout,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#ae81ff">2021-07-05</span> <span style="color:#ae81ff">18</span><span style="color:#f92672">:</span><span style="color:#ae81ff">52</span><span style="color:#f92672">:</span><span style="color:#ae81ff">24</span>,<span style="color:#ae81ff">264</span> <span style="color:#f92672">-</span> INFO <span style="color:#f92672">-</span> train_model.main <span style="color:#f92672">-</span> Starting train<span style="color:#f92672">-</span>model stage.
</code></pre></div><p>Similarly, the web API defined in <code>serve_model</code> can be started with,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> python <span style="color:#f92672">-</span>m pipeline.serve_model
</code></pre></div><p>Which should print the following to stdout,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s">INFO<span style="color:#f92672">:</span>     Started server process [21974]
INFO<span style="color:#f92672">:</span>     Waiting for application startup.
INFO<span style="color:#f92672">:</span>     Application startup complete.
INFO<span style="color:#f92672">:</span>     Uvicorn running on http<span style="color:#f92672">://</span><span style="color:#ae81ff">0.0.0.0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">8000</span> (Press CTRL<span style="color:#f92672">+</span>C to quit)
</code></pre></div><p>And make the API available for testing locally - e.g., issuing the following request from the command line,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> curl http<span style="color:#f92672">://</span>localhost<span style="color:#f92672">:</span><span style="color:#ae81ff">8000</span><span style="color:#f92672">/</span>api<span style="color:#f92672">/</span>v0.1<span style="color:#f92672">/</span>time_to_dispatch \
    <span style="color:#f92672">--</span>request POST \
    <span style="color:#f92672">--</span>header <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> \
    <span style="color:#f92672">--</span>data <span style="color:#e6db74">&#39;{&#34;product_code&#34;: &#34;001&#34;, &#34;orders_placed&#34;: 10}&#39;</span>
</code></pre></div><p>Should return,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;est_hours_to_dispatch&#34;</span>: <span style="color:#ae81ff">1.0</span>,
  <span style="color:#f92672">&#34;model_version&#34;</span>: <span style="color:#e6db74">&#34;0.1&#34;</span>
}
</code></pre></div><p>As defined in the tests. FastAPI will also automatically expose the following endpoints on your service:</p>
<ul>
<li>http://localhost:8000/docs - <a href="https://en.wikipedia.org/wiki/OpenAPI_Specification">OpenAPI</a> documentation for the API, with a UI for testing.</li>
<li>http://localhost:8000/openapi.json - the <a href="https://json-schema.org">JSON schema</a> for the API.</li>
</ul>
<h2 id="creating-a-deployment-environment">Creating a Deployment Environment</h2>
<p>Here at Bodywork HQ, we’re advocates for the <a href="https://blog.thepete.net/blog/2019/10/04/hello-production/">“Hello, Production”</a> school-of-thought, that encourages teams to make the deployment of a skeleton application (such as the trivial pipeline sketched-out in this article), one of the first tasks for any new project. As we have written about <a href="https://www.bodyworkml.com/posts/scikit-learn-meet-production">before</a>, there are many benefits to taking deployment pains early on in a software development project, and then using the initial deployment skeleton as the basis for rapidly delivering useful functionality into production.</p>
<p>We’re planning to deploy to Kubernetes using <a href="https://bodywork.readthedocs.io/en/latest/">Bodywork</a>, but we appreciate that not everyone has easy access to a Kubernetes cluster for development. If this is your reality, then the next best thing your team could do, is to start by deploying to a local test cluster, to make sure that the pipeline is at least deploy-able. You can get started with a single node cluster on your laptop, using Minikube - see <a href="https://bodywork.readthedocs.io/en/latest/kubernetes/#quickstart">our guide</a> to get this up-and-running in <strong>under 10 minutes</strong>.</p>
<p>The full description of the deployment is contained in <code>bodywork.yaml</code>, which we’ve reproduced below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">version</span>: <span style="color:#e6db74">&#34;1.1&#34;</span>
<span style="color:#66d9ef">pipeline</span>:
  <span style="color:#66d9ef">name</span>: time-to-dispatch
  <span style="color:#66d9ef">docker_image</span>: bodyworkml/bodywork-core:<span style="color:#ae81ff">3.1</span>
  <span style="color:#66d9ef">DAG</span>: train_model &gt;&gt; serve_model
<span style="color:#66d9ef">stages</span>:
  <span style="color:#66d9ef">train_model</span>:
    <span style="color:#66d9ef">executable_module_path</span>: pipeline/train_model.py
    <span style="color:#66d9ef">cpu_request</span>: <span style="color:#ae81ff">0.25</span>
    <span style="color:#66d9ef">memory_request_mb</span>: <span style="color:#ae81ff">100</span>
    <span style="color:#66d9ef">batch</span>:
      <span style="color:#66d9ef">max_completion_time_seconds</span>: <span style="color:#ae81ff">60</span>
      <span style="color:#66d9ef">retries</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">serve_model</span>:
    <span style="color:#66d9ef">executable_module_path</span>: pipeline/serve_model.py
    <span style="color:#66d9ef">requirements</span>:
      - fastapi==<span style="color:#ae81ff">0.65.2</span>
      - uvicorn==<span style="color:#ae81ff">0.14.0</span>
    <span style="color:#66d9ef">cpu_request</span>: <span style="color:#ae81ff">0.25</span>
    <span style="color:#66d9ef">memory_request_mb</span>: <span style="color:#ae81ff">100</span>
    <span style="color:#66d9ef">service</span>:
      <span style="color:#66d9ef">max_startup_time_seconds</span>: <span style="color:#ae81ff">90</span>
      <span style="color:#66d9ef">replicas</span>: <span style="color:#ae81ff">2</span>
      <span style="color:#66d9ef">port</span>: <span style="color:#ae81ff">8000</span>
      <span style="color:#66d9ef">ingress</span>: <span style="color:#66d9ef">true</span>
<span style="color:#66d9ef">logging</span>:
  <span style="color:#66d9ef">log_level</span>: INFO
</code></pre></div><p>This describes a deployment with two stages - <code>train-model</code> and <code>serve-model</code> - that are executed one after the other, as described in <code>pipeline.DAG</code>. For more information on how to configure a Bodywork deployment, checkout the <a href="https://bodywork.readthedocs.io/en/latest/user_guide/">User Guide</a>.</p>
<p>Once you have access to a test cluster, configure it for Bodywork deployments,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> bw configure<span style="color:#f92672">-</span>cluster
</code></pre></div><p>And then deploy the workflow directly from the GitHub repository (so make sure all commits have been pushed to your remote branch),</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> bw create deployment https<span style="color:#f92672">://</span>github.com<span style="color:#f92672">/</span>bodywork<span style="color:#f92672">-</span>ml<span style="color:#f92672">/</span>ml<span style="color:#f92672">-</span>pipeline<span style="color:#f92672">-</span>engineering <span style="color:#f92672">--</span>branch part<span style="color:#f92672">-</span>one
</code></pre></div><p>We like to watch our deployments rolling-out using the Kubernetes dashboard, as you can see in the video clip below.</p>

 <!-- ======= Portfolio Section ======= -->
      <section id="portfolio" class="portfolio">
        <div class="container" data-aos="fade-up">
          <div
            class="row portfolio-container"
            data-aos="fade-up"
            data-aos-delay="200"
          >
            <div class="col-lg-4 col-md-6 portfolio-item filter-app">
              <div class="portfolio-wrap">
              <p><img src="https://github.com/devopsengineerDan/engineer-dancun-personal-blog/assets/48592378/87d18387-2657-43e9-bf35-03864ac95b4e" alt="ml-pipeline-engineering" class="img-fluid"
                  alt=""</p>
              </div>    
            </div>

	  </div></div></section>
	    

	    

<p>Once the deployment has completed successfully, retrieve the details of the prediction service,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> bw get deployment time<span style="color:#f92672">-</span>to<span style="color:#f92672">-</span>dispatch serve<span style="color:#f92672">-</span>model
</code></pre></div><p>You can manually test the deployed prediction endpoint using,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-s" data-lang="s"><span style="color:#f92672">$</span> curl http<span style="color:#f92672">://</span>CLUSTER_IP<span style="color:#f92672">/</span>time<span style="color:#f92672">-</span>to<span style="color:#f92672">-</span>dispatch<span style="color:#f92672">/</span>serve<span style="color:#f92672">-</span>model<span style="color:#f92672">/</span>api<span style="color:#f92672">/</span>v0.1<span style="color:#f92672">/</span>time_to_dispatch \
    <span style="color:#f92672">--</span>request POST \
    <span style="color:#f92672">--</span>header <span style="color:#e6db74">&#34;Content-Type: application/json&#34;</span> \
    <span style="color:#f92672">--</span>data <span style="color:#e6db74">&#39;{&#34;product_code&#34;: &#34;001&#34;, &#34;orders_placed&#34;: 10}&#39;</span>
</code></pre></div><p>Which should return the same response as before,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#f92672">&#34;est_hours_to_dispatch&#34;</span>: <span style="color:#ae81ff">1.0</span>,
  <span style="color:#f92672">&#34;model_version&#34;</span>: <span style="color:#e6db74">&#34;0.1&#34;</span>
}
</code></pre></div><p>See our guide to <a href="https://bodywork.readthedocs.io/en/latest/kubernetes/#accessing-services">accessing services</a> for information on how to determine <code>CLUSTER_IP</code>.</p>
<h2 id="configuring-cicd">Configuring CI/CD</h2>

	 
	    
       <!-- ======= Portfolio Section ======= -->
      <section id="portfolio" class="portfolio">
        <div class="container" data-aos="fade-up">
          <div
            class="row portfolio-container"
            data-aos="fade-up"
            data-aos-delay="200"
          >
            <div class="col-lg-4 col-md-6 portfolio-item filter-app">
              <div class="portfolio-wrap">
              <p><img src="https://github.com/devopsengineerDan/engineer-dancun-personal-blog/assets/48592378/5c9e5a25-33ca-4afa-89e3-eb308dc562a5" alt="ci_workflow" class="img-fluid"
                  alt=""></p>
              </div>    
            </div>

	  </div></div></section>
	    
	    

<p>Now that the overall structure of the project has been created, all that remains is to put in-place the processes required to get new code merged and deployed as quickly and efficiently as possible. The process of getting new code merged on an <em>ad hoc</em>  basis, is referred to as Continuous Integration (CI), while getting new code deployed as soon as it is merged, is known as Continuous Deployment (CD). The workflow we intend to impose is outlined in the diagram above. Briefly:</p>
<ol>
<li>Pushing changes (commits) to the <code>master</code> branch of the repository is forbidden. All changes should first be raised as merge (or pull) requests, that have to pass all automated testing and some kind of peer review process (e.g. a code review), before they can be merged to the <code>master</code> branch.</li>
<li>Once changes are merged to the master branch, they can be deployed.</li>
</ol>
<p>Here at Bodywork HQ we use <a href="https://github.com/bodywork-ml/ml-pipeline-engineering">GitHub</a> and <a href="https://app.circleci.com/pipelines/github/bodywork-ml">CircleCI</a> to run this workflow. <a href="https://docs.github.com/en/github/administering-a-repository/defining-the-mergeability-of-pull-requests/about-protected-branches">Branch protection rules</a> on GitHub are used to prevent changes being pushed to master, unless automated tests and peer review have been passed. CircleCI is a paid-for CI/CD service (with an outrageously generous free-tier) that automatically integrates with GitHub to enable jobs (such as automated tests) to be triggered automatically following merge requests, or changes to the <code>master</code>branch, etc. Our CircleCI pipeline is defined in <code>.circleci/config.yml</code> and reproduced below.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#66d9ef">version</span>: <span style="color:#ae81ff">2.1</span>

<span style="color:#66d9ef">orbs</span>:
  <span style="color:#66d9ef">aws-eks</span>: circleci/aws-eks@<span style="color:#ae81ff">1.0.3</span>

<span style="color:#66d9ef">jobs</span>:
  <span style="color:#66d9ef">run-static-code-analysis</span>:
    <span style="color:#66d9ef">docker</span>:
      - <span style="color:#66d9ef">image</span>: circleci/python:<span style="color:#ae81ff">3.9</span>
    <span style="color:#66d9ef">steps</span>:
      - checkout
      - <span style="color:#66d9ef">run</span>:
          <span style="color:#66d9ef">name</span>: Installing Python dependencies
          <span style="color:#66d9ef">command</span>: pip install -r requirements_cicd.txt
      - <span style="color:#66d9ef">run</span>:
          <span style="color:#66d9ef">name</span>: Running tests
          <span style="color:#66d9ef">command</span>: tox -e py39_static_code_analysis
  <span style="color:#66d9ef">run-tests</span>:
    <span style="color:#66d9ef">docker</span>: 
      - <span style="color:#66d9ef">image</span>: circleci/python:<span style="color:#ae81ff">3.9</span>
    <span style="color:#66d9ef">steps</span>:
      - checkout
      - <span style="color:#66d9ef">run</span>:
          <span style="color:#66d9ef">name</span>: Installing Python dependencies
          <span style="color:#66d9ef">command</span>: pip install -r requirements_cicd.txt
      - <span style="color:#66d9ef">run</span>: 
          <span style="color:#66d9ef">name</span>: Running tests
          <span style="color:#66d9ef">command</span>: tox -e py39_unit_and_functional_tests
  <span style="color:#66d9ef">trigger-bodywork-deployment</span>:
    <span style="color:#66d9ef">executor</span>:
      <span style="color:#66d9ef">name</span>: aws-eks/python
      <span style="color:#66d9ef">tag</span>: <span style="color:#e6db74">&#34;3.9&#34;</span>
    <span style="color:#66d9ef">steps</span>:
      - <span style="color:#66d9ef">aws-eks/update-kubeconfig-with-authenticator</span>:
          <span style="color:#66d9ef">cluster-name</span>: bodywork-dev
      - checkout
      - <span style="color:#66d9ef">run</span>:
          <span style="color:#66d9ef">name</span>: Installing Python dependencies
          <span style="color:#66d9ef">command</span>: pip install -r requirements_cicd.txt
      - <span style="color:#66d9ef">run</span>: 
          <span style="color:#66d9ef">name</span>: Trigger Deployment
          <span style="color:#66d9ef">command</span>: bodywork create deployment https://github.com/bodywork-ml/ml-pipeline-engineering --branch master

<span style="color:#66d9ef">workflows</span>:
  <span style="color:#66d9ef">version</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#66d9ef">test-build-deploy</span>:
    <span style="color:#66d9ef">jobs</span>:
      - <span style="color:#66d9ef">run-static-code-analysis</span>:
          <span style="color:#66d9ef">filters</span>:
            <span style="color:#66d9ef">branches</span>:
              <span style="color:#66d9ef">ignore</span>: master
      - <span style="color:#66d9ef">run-tests</span>:
          <span style="color:#66d9ef">requires</span>:
            - run-static-code-analysis
          <span style="color:#66d9ef">filters</span>:
            <span style="color:#66d9ef">branches</span>:
              <span style="color:#66d9ef">ignore</span>: master
      - <span style="color:#66d9ef">trigger-bodywork-deployment</span>:
          <span style="color:#66d9ef">filters</span>:
            <span style="color:#66d9ef">branches</span>:
              <span style="color:#66d9ef">only</span>: master
</code></pre></div><p>Although this configuration file is specific to CircleCI, it will be easily recognisable to anyone who’s ever worked with similar services such as <a href="https://github.com/features/actions">GitHub Actions</a>, <a href="https://about.gitlab.com">GitLab CI/CD</a>, <a href="https://travis-ci.org">Travis CI</a>, etc. In essence, it defines the following:</p>
<ul>
<li>Three separate jobs: <code>run-static-code-analysis</code>, <code>run-tests</code> and <code>trigger-bodywork-deployment</code>. Each of these run in their own Docker container, with the project’s GitHub repo checked-out and any Python dependencies installed. The <code>trigger-bodywork-deployment</code> job is set to run on a custom AWS-managed image (or ‘Orb’), that comes with additional tools for working with AWS’s EKS (managed Kubernetes) service, which is our ultimate deployment target.</li>
<li>A workflow that is triggered upon every merge request: <code>run-static-code-analysis</code> is first executed, which runs <code>tox -e py39_static_code_analysis</code>. If this passes, then the <code>run-tests</code> job is executed, which runs <code>tox -e py39_unit_and_functional_tests</code>. If this also passes, then CircleCI will mark this workflow as ‘passed’ and report this back to GitHub (see below).</li>
<li>A workflow that is triggered upon every merge to <code>master</code>: <code>trigger-bodywork-deployment</code>is the only job in this pipeline, which uses Bodywork to deploy the latest pipeline (using rolling updates to maintain service availability).</li>
</ul>



	     <!-- ======= Portfolio Section ======= -->
      <section id="portfolio" class="portfolio">
        <div class="container" data-aos="fade-up">
          <div
            class="row portfolio-container"
            data-aos="fade-up"
            data-aos-delay="200"
          >
            <div class="col-lg-4 col-md-6 portfolio-item filter-app">
              <div class="portfolio-wrap">
              <p><img src="https://github.com/devopsengineerDan/engineer-dancun-personal-blog/assets/48592378/7710ef07-91d1-4e55-a9e1-91e76541f3ad"  class="img-fluid" 
                  alt=""></p>
              </div>    
            </div>

	  </div></div></section>

<h2 id="wrapping-up">Wrapping-Up</h2>
<p>In the first part of this project we have expended a lot of effort to lay the foundations for the work that is to come - developing the model training job, the prediction service and deploying these to a production environment where they will need to be monitored. Thanks to automated tests and CI/CD, our team will be able to quickly iterate towards a well-engineered solution, with results that can be demonstrated to stakeholders early on.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

      <div>
        <br>
        <div>
          <h5 class="title is-small">Share to social media</h5>
          <div>
            <a class="share share-network-twitter" style="background-color:#008080;"><i class="fab fah fa-lg fa-twitter"></i><span>Twitter</span></a>
            <a class="share share-network-facebook" style="background-color:#1877f2;"><i class="fab fah fa-lg fa-facebook-f"></i><span>Facebook</span></a>
            <a class="share share-network-linkedin" style="background-color:#2B1B17;"><i class="fab fah fa-lg fa-linkedin"></i><span>LinkedIn</span></a>
            <a class="share share-network-hackernews" style="background-color:#008000"><i class="fab fah fa-lg fa-hacker-news"></i><span>HackerNews</span></a>
            <a class="share share-network-pinterest" style="background-color:#bd081c;"><i class="fab fah fa-lg fa-pinterest"></i><span>Pinterest</span></a>
            <a class="share share-network-pocket" style="background-color:#7F38EC;"><i class="fab fah fa-lg fa-get-pocket"></i><span>Pocket</span></a>
            <a class="share share-network-email" style="background-color:#333333;"><i class="far fah fa-lg fa-envelope"></i><span>Email</span></a>
            <a class="share share-network-flipboard" style="background-color: #837E7C;"><i class="fab fah fa-lg fa-flipboard"></i><span>Flipboard</span></a>
            <a class="share share-network-quora" style="background-color:#808000;"><i class="fab fah fa-lg fa-quora"></i><span>Quora</span></a>
            <a class="share share-network-reddit" style="background-color: #581845
            ;"><i class="fab fah fa-lg fa-reddit-alien"></i><span>Reddit</span></a>
            <a class="share share-network-telegram" style="background-color:#000080;"><i class="fab fah fa-lg fa-telegram-plane"></i><span>Telegram</span></a>
            <a class="share share-network-whatsapp" style="background-color:#E55451;"><i class="fab fah fa-lg fa-whatsapp"></i><span>Whatsapp</span></a>
            <a class="share share-network-sms" style="background-color:#513B1C;"><i class="far fah fa-lg fa-comment-dots"></i><span>SMS</span></a>
          </div>
        </div>
      </div>
      <div class="comments">
        <div id="disqus_thread" pageConfig="[object Object]"></div>
      </div>
      
      <div id="disqus_thread"></div>
      <script>
          

          

          (function() { 
          var d = document, s = d.createElement('script');
          s.src = 'https://engineer-dancun-personal-blog.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
      </script>
      <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
      
      <br><br><br>
      <footer>
        &copy;  
        Powered by <a href="https://github.com/gohugoio/hugo" target="_blank">Hugo
      </footer>
      <script type="application/ld+json">
        {
          "@context" : "http://schema.org",
          "@type" : "Blog",
          "name": " Engineer Dancun ",
          "url" : "https://devopsengineerdan.github.io",
          "image": "./static/avatar.jpg",
          "description": "Software Engineer and Researcher"
        }
        </script>
        <script id="dsq-count-scr" src="//engineer-dancun.disqus.com/count.js" async></script>
    </main>
	  	
      <!-- End #main 

    <div id="preloader"></div>
    <a
      href="#"
      class="back-to-top d-flex align-items-center justify-content-center"
      ><i class="bi bi-arrow-up-short"></i
    ></a> -->


    <!-- Vendor JS Files -->
    <script src="https://devopsengineerdan.github.io/assets/vendor/purecounter/purecounter_vanilla.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/aos/aos.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/glightbox/js/glightbox.min.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/swiper/swiper-bundle.min.js"></script>
    <script src="https://devopsengineerdan.github.io/assets/vendor/waypoints/noframework.waypoints.js"></script>

    <!-- Template Main JS File -->
    <script src="https://devopsengineerdan.github.io/assets/js/main.js"></script>
  </body>
</html>

